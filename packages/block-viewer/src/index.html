<!DOCTYPE html>
<html>
  <head>
    <!-- script src='lib/tslib/tslib.js'></script -->
    <script src="lib/cryptographix/core/dist/index.umd.js"></script>
    <script>
      tslib = cryptographix.core.tslib;
    </script>
    <script src="lib/cryptographix/cryptography/dist/index.umd.js"></script>
    <script src="lib/cryptographix/payments/dist/index.umd.js"></script>
    <script>
      //import * as core from '/lib/cryptographix/core/dist/index.mjs';
      //import * as cryp from '/lib/cryptographix/cryptography/dist/index.mjs';
      let core = cryptographix.core;
      let ByteArray = core.ByteArray;
      let cryp = cryptographix.cryptography;
      let paym = cryptographix.payments;

      async function tr() {
        let tr31 = new paym.TR31();

        let kbpkKey = ByteArray.fromString(
          "88E1AB2A2E3DD38C1FA039A536500CC8A87AB9D62DC92C01058FA79F44657DE6",
          "hex"
        );

        await tr31.deriveBlockKeys("AES", kbpkKey);

        //console.log("k1:" + ByteArray.toString(keys.k1.key,'hex')) // is equal to '' but should be 014baf2278a69d331d5180103643e99a
        //console.log("k2:" + ByteArray.toString(keys.k2.key,'hex')) // is equal to '' but should be 014baf2278a69d331d5180103643e99a

        let examplePadding = ByteArray.fromString(
          "1C2965473CE206BB855B01533782",
          "hex"
        );

        tr31
          .setBlockHeader("D0112P0AE00E0000")
          .setBlockKeyData(
            ByteArray.fromString("3F419E1CB7079442AA37474C2EFBF8B8", "hex")
          )
          .padKeyData(32, examplePadding);

        let keyBlock = await tr31.generateKeyBlock();

        return keyBlock;
      }

      let xx = core.H2BA("0123456789abcdef0123456789abcdef");

      let enc = new cryp.SecretKeyEncrypter();
      let cfg = {
        //new cryp.SecretKeyEncrypterSettings();
        algorithm: "aes-128",
        key: xx,
        iv: xx //mode: 'ecb'
      };

      enc.settings = cfg;

      console.log(enc);

      enc
        .encode(xx)
        .then(res => {
          console.log(core.BA2H(res));
        })
        .catch(err => {
          console.log("Error: ", err);
        });

      tr()
        .then(keyBlock => {
          console.log("keyBlock:" + ByteArray.toString(keyBlock, "hex"));
        })
        .catch(e => {
          console.log(e);
        });

      //alert("Hi")
    </script>
  </head>
  <body></body>
</html>
